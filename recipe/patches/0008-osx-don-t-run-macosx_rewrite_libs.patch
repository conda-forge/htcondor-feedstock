From 054b3b5939289d7f272da90b1625ef1e1175608c Mon Sep 17 00:00:00 2001
From: Duncan Macleod <duncan.macleod@ligo.org>
Date: Fri, 14 Jan 2022 11:46:13 +0000
Subject: [PATCH 08/13] osx: don't run macosx_rewrite_libs

conda-build handles this for us
---
 bindings/python/CMakeLists.txt  | 2 +-
 src/classad/CMakeLists.txt      | 2 +-
 src/condor_utils/CMakeLists.txt | 2 ++
 3 files changed, 4 insertions(+), 2 deletions(-)

diff --git a/bindings/python/CMakeLists.txt b/bindings/python/CMakeLists.txt
index c00444fb59..d1eeac2aeb 100644
--- a/bindings/python/CMakeLists.txt
+++ b/bindings/python/CMakeLists.txt
@@ -196,7 +196,7 @@ if (WITH_PYTHON_BINDINGS OR WITH_PYTHON_BINDINGS_V2 OR WITH_PYTHON_BINDINGS_V3)
                     message( FATAL_ERROR \"\${_err}\" )
                 endif()
         ")
-        if (APPLE)
+        if (APPLE AND NOT "$ENV{CONDA_BUILD}" STREQUAL "1")
             set( MVI_SUFFIX ".abi3.so" )
             install( CODE "execute_process(COMMAND ${CMAKE_SOURCE_DIR}/src/condor_scripts/macosx_rewrite_libs \$ENV{DESTDIR}/${CMAKE_INSTALL_PREFIX}/${C_PYTHON3ARCHLIB}/classad2/classad2_impl${MVI_SUFFIX})" )
             install( CODE "execute_process(COMMAND ${CMAKE_SOURCE_DIR}/src/condor_scripts/macosx_rewrite_libs \$ENV{DESTDIR}/${CMAKE_INSTALL_PREFIX}/${C_PYTHON3ARCHLIB}/htcondor2/htcondor2_impl${MVI_SUFFIX})" )
diff --git a/src/classad/CMakeLists.txt b/src/classad/CMakeLists.txt
index 2f3b781e1d..2e138115aa 100644
--- a/src/classad/CMakeLists.txt
+++ b/src/classad/CMakeLists.txt
@@ -193,7 +193,7 @@ if (UNIX)
   target_link_libraries( classad ${CMAKE_DL_LIBS})
   install( TARGETS classad DESTINATION ${C_LIB_PUBLIC} )
 endif()
-if ( APPLE )
+if ( APPLE AND NOT "$ENV{CONDA_BUILD}" STREQUAL "1" )
   set_target_properties( classad PROPERTIES INSTALL_NAME_DIR ${CMAKE_CURRENT_BINARY_DIR}/lib )
   install( CODE "execute_process(COMMAND ${CMAKE_SOURCE_DIR}/src/condor_scripts/macosx_rewrite_libs \$ENV{DESTDIR}/${CMAKE_INSTALL_PREFIX}/${C_LIB_PUBLIC}/libclassad.${PACKAGE_VERSION}.dylib)" )
   target_link_libraries( classad pcre2-8)
diff --git a/src/condor_utils/CMakeLists.txt b/src/condor_utils/CMakeLists.txt
index 485e7e6614..c2749719a7 100644
--- a/src/condor_utils/CMakeLists.txt
+++ b/src/condor_utils/CMakeLists.txt
@@ -731,8 +731,10 @@ endif()
 
 if ( APPLE )
 	target_link_libraries( condor_utils PUBLIC ${IOKIT_FOUND} ${COREFOUNDATION_FOUND} resolv )
+	if ( NOT "$ENV{CONDA_BUILD}" STREQUAL "1")
 	set_target_properties( condor_utils PROPERTIES INSTALL_NAME_DIR ${CMAKE_CURRENT_BINARY_DIR} )
 	install( CODE "execute_process(COMMAND ${CMAKE_SOURCE_DIR}/src/condor_scripts/macosx_rewrite_libs \$ENV{DESTDIR}/${CMAKE_INSTALL_PREFIX}/${C_LIB}/lib${UTILS_LIB_NAME}.dylib)" )
+	endif()
 endif()
 
 ##################################################
-- 
2.43.0

